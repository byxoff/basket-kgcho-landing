name: Deploy Website
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup nginx (root)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ai.fastpanel.xpage.dev
          username: root
          password: ${{ secrets.SSH_ROOT_PASSWORD }}
          script: |
            # === ДИАГНОСТИКА FASTPANEL ===
            echo "=== FASTPANEL STATUS ==="
            systemctl status fastpanel2 2>&1 || echo "fastpanel2 service not found"
            ls /usr/local/fastpanel2/ 2>/dev/null && echo "FastPanel2 installed" || echo "FastPanel2 not installed"
            fastpanel2 2>/dev/null || /usr/local/fastpanel2/bin/cli 2>/dev/null || echo "No FastPanel CLI found"

            echo "=== FASTPANEL FIREWALL ==="
            # Проверить FastPanel firewall
            cat /etc/fastpanel2/firewall.json 2>/dev/null || echo "No fastpanel2 firewall config"
            ls /etc/fastpanel2/ 2>/dev/null || echo "No /etc/fastpanel2/"

            echo "=== NETWORK CHECK ==="
            # Проверить, слушает ли nginx снаружи
            ss -tlnp | grep -E ':80|:443'
            # Проверить внешнюю доступность
            curl -s --connect-timeout 5 http://185.152.92.246 2>&1 || echo "localhost can reach port 80"

            echo "=== FASTPANEL RESET PASSWORD ==="
            # Попробовать сбросить пароль FastPanel
            /usr/local/fastpanel2/bin/cli admin:password:reset 2>/dev/null || true
            /usr/local/fastpanel2/bin/cli user:password admin 2>/dev/null || true
            cat /usr/local/fastpanel2/.env 2>/dev/null | grep -i pass || echo "no .env"

            echo "=== FASTPANEL SITES ==="
            /usr/local/fastpanel2/bin/cli site:list 2>/dev/null || true
            ls /etc/nginx/sites-enabled/ 2>/dev/null || echo "no sites-enabled"
            cat /etc/fastpanel2/sites/*.json 2>/dev/null || echo "no fastpanel site configs"

            # Nginx конфиг
            CONF="/etc/nginx/conf.d/3x3chelbasket.conf"
            echo "nginx config already exists"
            nginx -t && systemctl reload nginx

      - name: Deploy app (fastuser)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ai.fastpanel.xpage.dev
          username: fastuser
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            export PATH=$HOME/.local/bin:$PATH:$HOME/.nvm/versions/node/$(node -v)/bin
            cd ~/site

            # СБРОСИТЬ ВСЕ ЛОКАЛЬНЫЕ ИЗМЕНЕНИЯ И ПОДТЯНУТЬ НОВЫЕ
            git fetch --all
            git reset --hard origin/main

            pnpm install
            pnpm --filter web build

            pm2 delete basket-site || true
            pm2 start ecosystem.config.cjs
            pm2 save
            sleep 3
            pm2 logs basket-site --lines 15 --nostream
            echo "--- curl check ---"
            curl -s -o /dev/null -w "HTTP %{http_code}" http://127.0.0.1:4321
            echo ""
