---
import '../assets/css/global.css'
import "../assets/css/base.css"
import "../assets/css/typography.css"
import "../assets/css/layout.css"
import "../assets/css/buttons.css"
import { getImage } from "astro:assets";
// БЕЗОПАСНЫЙ ИМПОРТ НАСТРОЕК
// Используем import.meta.glob, чтобы сборка не падала, если файл еще не создан в админке
const settingsFiles = import.meta.glob('../content/site-settings/index.json', { eager: true });
// Если файл есть - берем его, если нет - пустой объект
const siteSettings = settingsFiles['../content/site-settings/index.json'] || { headScripts: '', bodyScripts: '' };

// SEO Settings
const seoFiles = import.meta.glob('../content/seo/index.json', { eager: true });
const seoSettings = seoFiles['../content/seo/index.json'] || {};

const { title, description, image } = Astro.props

const defaultTitle = seoSettings.defaultTitle || "Международный кубок 3Х3 / 13-15 марта 2026 / Челябинск"
const defaultDescription = seoSettings.defaultDescription || 'Международный турнир по баскетболу 3Х3 / 13-15 марта 2026 / ДС «Юность»"'
const defaultImage = seoSettings.ogImage || "/tournament/logo-big.png";
const images = import.meta.glob('/src/assets/content/seo/**/*.{jpeg,jpg,png,gif,webp,svg}');

let ogImageUrl = defaultImage;

// Если картинка из Keystatic (@assets/content...), пытаемся ее найти и оптимизировать
if (defaultImage.startsWith('@assets/content')) {
   const fsPath = defaultImage.replace('@assets/content', '/src/assets/content');
   if (images[fsPath]) {
      try {
         const imgModule = await images[fsPath]();
         const optimized = await getImage({
            src: imgModule.default,
            format: 'jpeg', // Для соцсетей лучше jpeg/png
            width: 1200,    // Стандарт для OG
            height: 630
         });
         ogImageUrl = optimized.src;
      } catch (e) {
         console.error('OG Image optimization failed:', e);
         // Fallback to raw path if fail, though likely wont work due to @assets prefix
         ogImageUrl = "/tournament/logo-big.png"; 
      }
   }
}

// Формируем полный URL
const canonicalURL = new URL(Astro.url.pathname, Astro.site || Astro.url.origin);
const ogFullUrl = new URL(ogImageUrl, canonicalURL.origin).href;

console.log('SEO Debug:', { settingsTitle: seoSettings.defaultTitle, finalTitle: title ?? defaultTitle, ogFullUrl });
---
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    
    <script is:inline>
      if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost') {
        window.location.href = window.location.href.replace('http:', 'https:');
      }
    </script>
    
    <!-- Вставка скриптов из Админки (Head) -->
    <!-- Astro сам умный: если переменной нет, он ничего не выведет, но проверка `?` нужна -->
    {siteSettings?.headScripts && <Fragment set:html={siteSettings.headScripts} />}
    <title>{ title ?? defaultTitle }</title>
    <link rel="icon" type="image/svg+xml" href="/tournament/logo.svg" />
    <meta name="description" content={ description ?? defaultDescription } />
    <meta name="theme-color" content="#D85A21" />
    <meta property="og:title" content={ title ?? defaultTitle } />
    <meta property="og:description" content={ description ?? defaultDescription } />
    <meta property="og:image" content={ ogFullUrl } />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Yandex Tickets Dealer Config -->
    <script is:inline>
      window.YandexTicketsDealer = window.YandexTicketsDealer || [];
      YandexTicketsDealer.push(['setDefaultClientKey', '2c4a0e91-c3fa-4469-9e2f-acffa4a5ddd2']);
      YandexTicketsDealer.push(['setDefaultRegionId', 56]);
      (function () {
        var rnd = '?' + new Date().getTime() * Math.random();
        var script = document.createElement('script');
        var target = document.getElementsByTagName('script')[0];
        script.async = true;
        script.src = 'https://widget.afisha.yandex.ru/dealer/dealer.js'+rnd;
        target.parentNode.insertBefore(script, target);
      })();
    </script>
  </head>
  <body id="top">
    <div id="ya-widget-frame" class="fixed inset-0 z-[9999] pointer-events-none empty:hidden bg-black/60 flex items-center justify-center">
    </div>
    {siteSettings?.bodyScripts && <Fragment set:html={siteSettings.bodyScripts} />}
    <a class="fixed -top-20 focus-visible:top-0 p-3 bg-black/90 transition-all duration-300" href="#main">Skip to content</a>
    <main id="main">
      <slot />
    </main>
    
    <!-- Скрипт закрытия виджета -->
    <script is:inline>
      const widgetFrame = document.getElementById('ya-widget-frame');
      const observer = new MutationObserver((mutations) => {
        if (widgetFrame.hasChildNodes() && !widgetFrame.querySelector('.close-widget-btn')) {
           const closeBtn = document.createElement('button');
           closeBtn.className = 'close-widget-btn absolute top-5 right-5 z-[10000] text-white bg-red-600 rounded-full w-10 h-10 flex items-center justify-center font-bold shadow-lg hover:bg-red-700 pointer-events-auto cursor-pointer';
           closeBtn.innerHTML = 'X';
           closeBtn.onclick = () => {
             widgetFrame.innerHTML = '';
             widgetFrame.classList.add('pointer-events-none');
           };
           widgetFrame.appendChild(closeBtn);
           widgetFrame.classList.remove('pointer-events-none');
        }
      });
      observer.observe(widgetFrame, { childList: true });
    </script>
  </body>
</html>
