---
// Медиа галерея - лучшие моменты прошлого турнира
import Image from "astro/components/Image.astro";
import media from '../../content/media/index.json';
// Функция для получения правильного пути к картинке (поддержка и строк, и импортов Vite)
// Используем RECURSIVE (**) glob import, чтобы находить картинки в подпапках (gallery/0/...)
const images = import.meta.glob('/src/assets/content/media/**/*.{jpeg,jpg,png,gif,webp,svg}');
const { showSection = true, videoUrl, videoPreview } = media;
// Обработка превью видео: если это путь к ассету, пробуем найти его в imports
// Если это URL, оставляем как есть.
import { getImage } from "astro:assets";
let videoPreviewSrc = videoPreview || "";
try {
  if (videoPreviewSrc && videoPreviewSrc.startsWith('@assets/content')) {
      const videoPreviewPath = videoPreviewSrc.replace('@assets/content', '/src/assets/content');
      if (images && images[videoPreviewPath]) {
          const imgModule = await images[videoPreviewPath]();
          const optimizedImg = await getImage({ src: imgModule.default, format: 'webp' });
          videoPreviewSrc = optimizedImg.src;
      }
  }
} catch (e) {
  console.error("Error processing video preview image:", e);
  // Fallback or leave as is (broken path)
}
// Функция для получения embed ссылки VK Video
function getVkEmbedUrl(url) {
  if (!url) return null;
  // RegEx для разных форматов ссылок VK Video
  // vk.com/video-223943791_456239019
  // vk.com/video_ext.php?oid=...
  const videoRegex = /video(-?\d+)_(\d+)/;
  const match = url.match(videoRegex);
  
  if (match) {
    const oid = match[1];
    const id = match[2];
    // Формируем ссылку для iframe
    return `https://vk.com/video_ext.php?oid=${oid}&id=${id}&hd=2&autoplay=1`;
  }
  return null;
}
const vkEmbedUrl = getVkEmbedUrl(videoUrl);
const isVkVideo = !!vkEmbedUrl;
---
{showSection && (
<section class="w-full bg-[#0F0F0F] flex flex-col overflow-hidden" id="media">
  
  <!-- Block 1: Header & Player -->
  <div class="relative w-full overflow-hidden flex justify-center pt-[67px] pb-[50px] z-[2]">
    <!-- Background Top -->
    <div class="absolute inset-0 pointer-events-none z-0">
      <img src="/tournament/bg-elements-media.svg" class="absolute left-1/2 -translate-x-1/2 top-0 min-w-full h-auto opacity-50" alt="" />
    </div>
    <div class="relative z-10 w-full max-w-[1440px] flex flex-col items-center px-4">
      <header class="text-center mb-[54px]">
        <h2 class="font-bebas font-bold text-[64px] text-white leading-none m-0 uppercase tracking-tight">Медиа галерея</h2>
        <p class="!font-montserrat font-semibold text-[16px] text-white/90 mt-4 mb-0 tracking-[0.2em] uppercase text-center">Лучшие моменты прошлого турнира</p>
      </header>
      <!-- Контейнер плеера -->
      <div 
        class="w-[1160px] max-w-full aspect-video bg-[#2C2C2C] border-4 border-tournament-orange rounded-sm shadow-[0px_0px_30px_rgba(216,90,33,0.3)] flex justify-center items-center relative group overflow-hidden"
        id="video-player-container"
        data-vk-url={vkEmbedUrl}
        data-fallback-url={videoUrl}
      >
        <!-- Preview background (manual implementation to merge user request + preview feature) -->
        <div class="absolute inset-0 bg-cover bg-center z-0 transition-opacity duration-300"
             style={videoPreviewSrc ? `background-image: url('${videoPreviewSrc}');` : ''} 
             id="video-preview-layer">
             <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors duration-300"></div>
        </div>
        <!-- Кнопка Play (изначально видна) -->
        <button 
          id="play-video-btn" 
          class="bg-none border-none cursor-pointer w-[142px] h-[142px] transition-transform duration-300 hover:scale-110 z-10 flex items-center justify-center rounded-full" 
          aria-label="Воспроизвести видео"
        >
          <img src="/tournament/icon-play.svg" alt="Play" class="w-full h-full drop-shadow-xl" />
        </button>
        <p id="video-placeholder-text" class="absolute bottom-10 text-white/50 text-sm z-10">
          {videoUrl ? 'Нажмите, чтобы открыть видео' : 'Видео недоступно'}
        </p>
        <!-- Место для iframe (добавится JS-ом) -->
      </div>
    </div>
  </div>
  <!-- Divider -->
  <div class="relative w-full h-[46px] bg-tournament-orange z-[3] shadow-lg"></div>
  <!-- Script для вставки видео -->
  <script>
    const container = document.getElementById('video-player-container');
    const playBtn = document.getElementById('play-video-btn');
    const textLabel = document.getElementById('video-placeholder-text');
    const previewLayer = document.getElementById('video-preview-layer');
    if (container && playBtn) {
      playBtn.addEventListener('click', () => {
        const vkUrl = container.dataset.vkUrl;
        const fallbackUrl = container.dataset.fallbackUrl;
        // Hide preview elements
        if (previewLayer) previewLayer.style.display = 'none';
        playBtn.style.display = 'none';
        if (textLabel) textLabel.style.display = 'none';
        if (vkUrl) {
          // Если это VK Video -> вставляем iframe
          const iframe = document.createElement('iframe');
          iframe.src = vkUrl;
          iframe.width = "100%";
          iframe.height = "100%";
          iframe.allow = "autoplay; encrypted-media; fullscreen; picture-in-picture;";
          iframe.frameBorder = "0"; // Note: deprecated but useful for fallbacks
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";
          iframe.setAttribute('allowfullscreen', 'true');
          
          container.appendChild(iframe);
        } else if (fallbackUrl) {
             
             // Check youtube
             if (fallbackUrl.includes('youtube.com') || fallbackUrl.includes('youtu.be')) {
                let embedUrl = fallbackUrl;
                const videoId = fallbackUrl.includes('v=') ? fallbackUrl.split('v=')[1].split('&')[0] : fallbackUrl.split('/').pop();
                embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                
                const iframe = document.createElement('iframe');
                iframe.src = embedUrl;
                iframe.style.width = "100%";
                iframe.style.height = "100%";
                iframe.style.border = "none";
                iframe.allow = "autoplay; encrypted-media; fullscreen; picture-in-picture;";
                iframe.setAttribute('allowfullscreen', 'true');
                container.appendChild(iframe);
             } else {
                // Если другая ссылка -> открываем в новой вкладке (как раньше)
                // Restore preview because we are opening in new tab
                if (previewLayer) previewLayer.style.display = 'block';
                playBtn.style.display = 'flex';
                if (textLabel) textLabel.style.display = 'block';
                
                window.open(fallbackUrl, '_blank');
             }
        }
      });
    }
  </script>
  <!-- Block 2: Gallery Grid -->
  <div class="relative w-full flex justify-center pt-[80px] pb-[120px] z-[1] bg-black">
    <!-- Background Elements (Basketballs scattered) -->
    <div class="absolute inset-0 pointer-events-none z-0 opacity-60">
       <img src="/tournament/gallery-bg-balls.png" class="w-full h-full object-cover" alt="" />
    </div>
    <div class="relative z-10 w-full max-w-[1440px] px-4 flex flex-col items-center">
      <div class="relative w-full lg:h-[750px] h-auto max-w-[1397px]">
        
        <!-- Center Logo (Desktop Only) -->
        <div class="absolute left-1/2 top-[45%] -translate-x-1/2 -translate-y-1/2 z-[2] w-[600px] pointer-events-none drop-shadow-2xl max-lg:hidden">
          <img src="/tournament/gallery-center-logo.png" alt="Logo" class="w-full h-auto animate-pulse-slow" />
        </div>
        <!-- Desktop Grid -->
        <div class="hidden lg:block relative h-full">
          {media.gallery && media.gallery.length > 0 && media.gallery.slice(0, 5).map((item, index) => {
             const rawPath = item.image;
             // Убираем @assets/content и подставляем реальный путь
             const fsPath = rawPath?.replace('@assets/content', '/src/assets/content');
             const imgImport = images[fsPath];
             
             return (
             <a href={item.link || "#"} target="_blank"
                class={`gallery-card gallery-pos-${index + 1} group`}
              >
                {/* Если это локальная картинка через Keystatic */}
                {imgImport ? (
                   <Image src={imgImport()} alt={item.alt || ""} class="w-full h-full object-cover" />
                ) : (
                   /* Fallback если картинка внешняя или путь сломался */
                   <img src={rawPath} alt={item.alt || ""} class="w-full h-full object-cover" />
                )}
                <div class="absolute inset-0 bg-black/40 group-hover:bg-transparent transition-colors duration-500">
                  {item.alt && (
                    <div class="absolute bottom-0 left-0 w-full bg-tournament-orange/90 p-3 translate-y-full group-hover:translate-y-0 transition-transform duration-300 pointer-events-none">
                      <p class="text-white text-xs font-bold uppercase text-center m-0 font-bebas tracking-wider">{item.alt}</p>
                    </div>
                  )}
                </div>
              </a>
          )})}
        </div>
        <!-- Mobile/Tablet Grid -->
        <div class="lg:hidden grid grid-cols-1 sm:grid-cols-2 gap-8 mb-12">
           {media.gallery && media.gallery.map((item) => {
             const rawPath = item.image;
             const fsPath = rawPath?.replace('@assets/content', '/src/assets/content');
             const imgImport = images[fsPath];
             return (
             <a href={item.link || "#"} target="_blank" class="block aspect-video bg-[#2C2C2C] border-2 border-tournament-orange rounded-lg overflow-hidden relative">
                 {imgImport ? (
                   <Image src={imgImport()} alt={item.alt || ""} class="w-full h-full object-cover" />
                ) : (
                   <img src={rawPath} alt={item.alt || ""} class="w-full h-full object-cover" />
                )}
             </a>
           )})}
        </div>
      </div>
    </div>
  </div>
</section>
)}
<style>
  .gallery-card {
    position: absolute;
    width: 448px;
    height: 264px;
    background-color: #2C2C2C;
    border: 3px solid #D85921;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.5);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 1;
  }
  .gallery-card:hover {
    transform: scale(1.05);
    z-index: 5;
    border-color: #ffffff;
    box-shadow: 0px 15px 50px rgba(216, 89, 33, 0.4);
  }
  /* Точное позиционирование на основе Figma (относительно контейнера 1397x750) */
  .gallery-pos-1 { top: 0; left: 0; }             /* Rectangle 12 */
  .gallery-pos-2 { top: 0; right: 0; }            /* Rectangle 15 */
  .gallery-pos-3 { top: 350px; right: 80px; }     /* Rectangle 13 (чуть внутрь) */
  .gallery-pos-4 { bottom: 0; left: 50%; transform: translateX(-50%); } 
  .gallery-pos-4:hover { transform: translateX(-50%) scale(1.05); } 
  .gallery-pos-5 { top: 350px; left: 80px; }      /* Rectangle 14 (чуть внутрь) */
  .animate-pulse-slow {
    animation: pulse-slow 4s ease-in-out infinite;
  }
  @keyframes pulse-slow {
    0%, 100% { opacity: 1; transform: translateY(0); }
    50% { opacity: 0.9; transform: translateY(-10px); }
  }
</style>
