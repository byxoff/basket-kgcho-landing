---
// Медиа галерея - лучшие моменты прошлого турнира
import Image from "astro/components/Image.astro";
import { getImage } from "astro:assets";
// Функция для получения правильного пути к картинке (поддержка и строк, и импортов Vite)
// Используем RECURSIVE (**) glob import, чтобы находить картинки в подпапках (gallery/0/...)
const images = import.meta.glob('/src/assets/content/media/**/*.{jpeg,jpg,png,gif,webp,svg}');

// Safe Data Load
const mediaFiles = import.meta.glob('../../content/media/index.json', { eager: true });
const media = mediaFiles['../../content/media/index.json'] || {};

const { showSection = true, videoUrl, videoPreview } = media;
let videoPreviewSrc = "";
// Безопасное разрешение картинки для превью
if (videoPreview) {
  // 1. Обработка локальных ассетов Keystatic
  if (videoPreview.startsWith('@assets/content')) {
     const fsPath = videoPreview.replace('@assets/content', '/src/assets/content');
     
     // Проверяем, есть ли такой файл в glob-импортах
     if (images[fsPath]) {
        try {
           // Получаем модуль картинки
           const imgModule = await images[fsPath]();
           // Оптимизируем через Astro getImage
           const optimized = await getImage({ 
              src: imgModule.default, 
              format: 'webp',
              width: 1280, // Оптимальная ширина для превью
              quality: 80 
           });
           videoPreviewSrc = optimized.src;
        } catch (e) {
           console.error(`[MediaSection] Preview image optimization failed for ${fsPath}:`, e);
           // При ошибке просто оставляем пустым, чтобы не рушить страницу
        }
     } else {
        console.warn(`[MediaSection] Preview image not found in glob: ${fsPath}. Check file existence and path.`);
        // Для отладки: выводим, что вообще есть (первые 5)
        // console.log("Available images:", Object.keys(images).slice(0, 5));
     }
  } else {
     // 2. Если это просто URL (например, image.jpg или https://...)
     videoPreviewSrc = videoPreview;
  }
}
// Функция для получения embed ссылки VK Video
function getVkEmbedUrl(url) {
  if (!url) return null;
  // RegEx для разных форматов ссылок VK Video
  // vk.com/video-223943791_456239019
  // vk.com/video_ext.php?oid=...
  const videoRegex = /video(-?\d+)_(\d+)/;
  const match = url.match(videoRegex);
  
  if (match) {
    const oid = match[1];
    const id = match[2];
    // Формируем ссылку для iframe
    return `https://vk.com/video_ext.php?oid=${oid}&id=${id}&hd=2&autoplay=1`;
  }
  return null;
}
const vkEmbedUrl = getVkEmbedUrl(videoUrl);
---
{showSection && (
<section class="w-full bg-[#0F0F0F] flex flex-col overflow-hidden" id="media">
  
  <!-- Block 1: Header & Player -->
  <div class="relative w-full overflow-hidden flex justify-center pt-[67px] pb-[50px] z-[2]">
    <!-- Background Top -->
    <div class="absolute inset-0 pointer-events-none z-0">
      <img src="/tournament/bg-elements-media.svg" class="absolute left-1/2 -translate-x-1/2 top-0 min-w-full h-auto opacity-50" alt="" />
    </div>
    <div class="relative z-10 w-full max-w-[1440px] flex flex-col items-center px-4">
      <header class="text-center mb-[54px]">
        <h2 class="font-bebas font-bold text-[64px] text-white leading-none m-0 uppercase tracking-tight">Медиа галерея</h2>
        <p class="!font-montserrat font-semibold text-[16px] text-white/90 mt-4 mb-0 tracking-[0.2em] uppercase text-center">Лучшие моменты прошлого турнира</p>
      </header>
      <!-- Контейнер плеера -->
      <div 
        class="w-[1160px] max-w-full aspect-video bg-[#2C2C2C] border-4 border-tournament-orange rounded-sm shadow-[0px_0px_30px_rgba(216,90,33,0.3)] flex justify-center items-center relative group overflow-hidden"
        id="video-player-container"
        data-vk-url={vkEmbedUrl}
        data-fallback-url={videoUrl}
      >
        <!-- Preview background -->
        <!-- Используем videoPreviewSrc, полученный из getImage -->
        <div class="absolute inset-0 bg-cover bg-center z-0 transition-opacity duration-300"
             style={videoPreviewSrc ? `background-image: url('${videoPreviewSrc}');` : ''} 
             id="video-preview-layer">
             <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors duration-300"></div>
        </div>
        <!-- Кнопка Play (изначально видна) -->
        <button 
          id="play-video-btn" 
          class="bg-none border-none cursor-pointer w-[142px] h-[142px] transition-transform duration-300 hover:scale-110 z-10 flex items-center justify-center rounded-full" 
          aria-label="Воспроизвести видео"
        >
          <img src="/tournament/icon-play.svg" alt="Play" class="w-full h-full drop-shadow-xl" />
        </button>
        <p id="video-placeholder-text" class="absolute bottom-10 text-white/50 text-sm z-10">
          {videoUrl ? 'Нажмите, чтобы открыть видео' : 'Видео недоступно'}
        </p>
        <!-- Место для iframe (добавится JS-ом) -->
      </div>
    </div>
  </div>
  <!-- Divider -->
  <div class="relative w-full h-[46px] bg-tournament-orange z-[3] shadow-lg"></div>
  <!-- Script для вставки видео -->
  <script>
    const container = document.getElementById('video-player-container');
    const playBtn = document.getElementById('play-video-btn');
    const textLabel = document.getElementById('video-placeholder-text');
    const previewLayer = document.getElementById('video-preview-layer');
    if (container && playBtn) {
      playBtn.addEventListener('click', () => {
        const vkUrl = container.dataset.vkUrl;
        const fallbackUrl = container.dataset.fallbackUrl;
        // Hide preview elements
        if (previewLayer) previewLayer.style.display = 'none';
        playBtn.style.display = 'none';
        if (textLabel) textLabel.style.display = 'none';
        if (vkUrl) {
          // Если это VK Video -> вставляем iframe
          const iframe = document.createElement('iframe');
          iframe.src = vkUrl;
          iframe.width = "100%";
          iframe.height = "100%";
          iframe.allow = "autoplay; encrypted-media; fullscreen; picture-in-picture;";
          iframe.frameBorder = "0"; // Note: deprecated but useful for fallbacks
          iframe.style.width = "100%";
          iframe.style.height = "100%";
          iframe.style.border = "none";
          iframe.setAttribute('allowfullscreen', 'true');
          
          container.appendChild(iframe);
        } else if (fallbackUrl) {
             
             // Check youtube
             if (fallbackUrl.includes('youtube.com') || fallbackUrl.includes('youtu.be')) {
                let embedUrl = fallbackUrl;
                const videoId = fallbackUrl.includes('v=') ? fallbackUrl.split('v=')[1].split('&')[0] : fallbackUrl.split('/').pop();
                embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                
                const iframe = document.createElement('iframe');
                iframe.src = embedUrl;
                iframe.style.width = "100%";
                iframe.style.height = "100%";
                iframe.style.border = "none";
                iframe.allow = "autoplay; encrypted-media; fullscreen; picture-in-picture;";
                iframe.setAttribute('allowfullscreen', 'true');
                container.appendChild(iframe);
             } else {
                // Если другая ссылка -> открываем в новой вкладке (как раньше)
                // Restore preview because we are opening in new tab
                if (previewLayer) previewLayer.style.display = 'block';
                playBtn.style.display = 'flex';
                if (textLabel) textLabel.style.display = 'block';
                
                window.open(fallbackUrl, '_blank');
             }
        }
      });
    }
  </script>
  <!-- Block 2: Gallery Grid -->
  <div class="relative w-full flex justify-center pt-[80px] pb-[120px] z-[1] bg-black">
    <!-- Background Elements (Basketballs scattered) -->
    <div class="absolute inset-0 pointer-events-none z-0 opacity-60">
       <img src="/tournament/gallery-bg-balls.png" class="w-full h-full object-cover" alt="" />
    </div>
    <div class="relative z-10 w-full max-w-[1440px] px-4 flex flex-col items-center">
      <div class="relative w-full lg:h-[750px] h-auto max-w-[1397px]">
        
        <!-- Center Logo (Desktop Only) -->
        <div class="absolute left-1/2 top-[45%] -translate-x-1/2 -translate-y-1/2 z-[2] w-[600px] pointer-events-none drop-shadow-2xl max-lg:hidden">
          <img src="/tournament/gallery-center-logo.png" alt="Logo" class="w-full h-auto animate-pulse-slow" />
        </div>
        <!-- Desktop Grid -->
        <div class="hidden lg:block relative h-full">
          {media.gallery && media.gallery.length > 0 && media.gallery.slice(0, 5).map((item, index) => {
             const rawPath = item.image;
             // Убираем @assets/content и подставляем реальный путь
             const fsPath = rawPath?.replace('@assets/content', '/src/assets/content');
             const imgImport = images[fsPath];
             
             return (
             <a href={item.link || "#"} target={item.openInNewTab ? "_blank" : "_self"}
                class={`gallery-card gallery-pos-${index + 1} group`}
              >
                {/* Если это локальная картинка через Keystatic */}
                {imgImport ? (
                   <Image src={imgImport()} alt={item.alt || ""} class="w-full h-full object-cover" />
                ) : (
                   /* Fallback если картинка внешняя или путь сломался */
                   <img src={rawPath} alt={item.alt || ""} class="w-full h-full object-cover" />
                )}
                <div class="absolute inset-0 bg-black/40 group-hover:bg-transparent transition-colors duration-500">
                  {item.alt && (
                    <div class="absolute bottom-0 left-0 w-full bg-tournament-orange/90 p-3 translate-y-full group-hover:translate-y-0 transition-transform duration-300 pointer-events-none">
                      <p class="text-white text-xs font-bold uppercase text-center m-0 font-bebas tracking-wider">{item.alt}</p>
                    </div>
                  )}
                </div>
              </a>
          )})}
        </div>
        <!-- Mobile/Tablet Grid -->
        <div class="lg:hidden grid grid-cols-1 sm:grid-cols-2 gap-8 mb-12">
           {media.gallery && media.gallery.map((item) => {
             const rawPath = item.image;
             const fsPath = rawPath?.replace('@assets/content', '/src/assets/content');
             const imgImport = images[fsPath];
             return (
             <a href={item.link || "#"} target={item.openInNewTab ? "_blank" : "_self"} class="block aspect-video bg-[#2C2C2C] border-2 border-tournament-orange rounded-lg overflow-hidden relative">
                 {imgImport ? (
                   <Image src={imgImport()} alt={item.alt || ""} class="w-full h-full object-cover" />
                ) : (
                   <img src={rawPath} alt={item.alt || ""} class="w-full h-full object-cover" />
                )}
             </a>
           )})}
        </div>
      </div>
    </div>
  </div>
</section>
)}
<style>
  .gallery-card {
    position: absolute;
    width: 448px;
    height: 264px;
    background-color: #2C2C2C;
    border: 3px solid #D85921;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.5);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 1;
  }
  .gallery-card:hover {
    transform: scale(1.05);
    z-index: 5;
    border-color: #ffffff;
    box-shadow: 0px 15px 50px rgba(216, 89, 33, 0.4);
  }
  /* Точное позиционирование на основе Figma (относительно контейнера 1397x750) */
  .gallery-pos-1 { top: 0; left: 0; }             /* Rectangle 12 */
  .gallery-pos-2 { top: 0; right: 0; }            /* Rectangle 15 */
  .gallery-pos-3 { top: 350px; right: 80px; }     /* Rectangle 13 (чуть внутрь) */
  .gallery-pos-4 { bottom: 0; left: 50%; transform: translateX(-50%); } 
  .gallery-pos-4:hover { transform: translateX(-50%) scale(1.05); } 
  .gallery-pos-5 { top: 350px; left: 80px; }      /* Rectangle 14 (чуть внутрь) */
  .animate-pulse-slow {
    animation: pulse-slow 4s ease-in-out infinite;
  }
  @keyframes pulse-slow {
    0%, 100% { opacity: 1; transform: translateY(0); }
    50% { opacity: 0.9; transform: translateY(-10px); }
  }
</style>

<!-- Lightbox Viewer -->
<div id="lightbox" class="fixed inset-0 z-[9999] bg-black/95 hidden opacity-0 transition-opacity duration-300 flex items-center justify-center p-4 backdrop-blur-sm" aria-hidden="true">
  <!-- Close Button -->
  <button id="lightbox-close" class="absolute top-5 right-5 text-white/70 hover:text-white transition-colors z-50 p-2 cursor-pointer">
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </button>
  
  <!-- Navigation Prev -->
  <button id="lightbox-prev" class="absolute left-2 md:left-8 top-1/2 -translate-y-1/2 text-white/70 hover:text-tournament-orange transition-colors z-50 p-4 cursor-pointer">
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
  </button>
  
  <!-- Navigation Next -->
  <button id="lightbox-next" class="absolute right-2 md:right-8 top-1/2 -translate-y-1/2 text-white/70 hover:text-tournament-orange transition-colors z-50 p-4 cursor-pointer">
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
  </button>
  
  <!-- Open Original Button (Top Right, left of close) -->
  <a id="lightbox-open-original" href="#" target="_blank" class="absolute top-5 right-20 text-white/70 hover:text-white transition-colors z-50 p-2 cursor-pointer" title="Открыть в новой вкладке">
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
  </a>

  <!-- Image Container -->
  <div class="relative w-full h-full flex flex-col items-center justify-center pointer-events-none">
     <img id="lightbox-img" src="" alt="Gallery Preview" class="max-w-[90vw] max-h-[85vh] object-contain shadow-2xl rounded-sm pointer-events-auto select-none transition-transform duration-300" />
     <p id="lightbox-caption" class="text-white/90 font-montserrat text-lg mt-4 text-center max-w-2xl px-4 pointer-events-auto"></p>
  </div>
</div>

<script>
  // Lightbox Logic
  document.addEventListener('DOMContentLoaded', () => {
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const closeBtn = document.getElementById('lightbox-close');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    
    // Select both desktop and mobile gallery links
    const triggers = document.querySelectorAll('.gallery-card, .lg\\:hidden a.block');
    let currentIndex = 0;
    
    // Function to show image at index
    const showImage = (index) => {
      if (index < 0) index = triggers.length - 1;
      if (index >= triggers.length) index = 0;
      currentIndex = index;
      
      const trigger = triggers[index];
      const img = trigger.querySelector('img');
      const captionText = img.getAttribute('alt');
      
      // Use original source if possible, otherwise use current src
      // Assuming layout creates high-res enough images or acceptable webp
      const src = img.currentSrc || img.src;
      
      lightboxImg.src = src;
      lightboxCaption.textContent = captionText || '';
      
      // Update open original link
      const openOriginalBtn = document.getElementById('lightbox-open-original');
      if (openOriginalBtn) {
        openOriginalBtn.href = src;
      }
    };

    // Open Lightbox
    triggers.forEach((trigger, index) => {
      // Add visual cue
      trigger.style.cursor = 'zoom-in';
      
      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        showImage(index);
        lightbox.classList.remove('hidden');
        // Small delay for fade in
        requestAnimationFrame(() => {
          lightbox.classList.remove('opacity-0');
        });
        document.body.style.overflow = 'hidden'; // Lock scroll
      });
    });

    // Close Lightbox
    const closeLightbox = () => {
      lightbox.classList.add('opacity-0');
      setTimeout(() => {
        lightbox.classList.add('hidden');
        lightboxImg.src = '';
      }, 300);
      document.body.style.overflow = '';
    };

    closeBtn.addEventListener('click', closeLightbox);
    
    // Close on click outside
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox || e.target.closest('.relative') === lightbox.querySelector('.relative')) {
        // Did not click the image itself (the relative container helps center it, but e.target check is safer)
        if (e.target !== lightboxImg && e.target !== prevBtn && e.target !== nextBtn && !prevBtn.contains(e.target) && !nextBtn.contains(e.target)) {
           closeLightbox();
        }
      }
    });

    // Navigation
    prevBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      showImage(currentIndex - 1);
    });
    
    nextBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      showImage(currentIndex + 1);
    });

    // Keyboard support
    document.addEventListener('keydown', (e) => {
      if (lightbox.classList.contains('hidden')) return;
      
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showImage(currentIndex - 1);
      if (e.key === 'ArrowRight') showImage(currentIndex + 1);
    });
  });
</script>
